import os
import requests
import json

# ุงูุญุตูู ุนูู ุฅุนุฏุงุฏุงุช DeepSeek API ูู ููู .env
DEEPSEEK_API_KEY = os.environ.get('DEEPSEEK_API_KEY', 'your_deepseek_api_key')
DEEPSEEK_API_URL = os.environ.get('DEEPSEEK_API_URL', 'https://api.deepseek.com/v1/chat/completions')
DEFAULT_MODEL = os.environ.get('DEFAULT_MODEL', 'deepseek-chat')
MAX_TOKENS = int(os.environ.get('MAX_TOKENS', 200))
TEMPERATURE = float(os.environ.get('TEMPERATURE', 0.7))

def process_with_deepseek(text, user_info):
    """
    ูุนุงูุฌุฉ ุฑุณุงุฆู ุงููุณุชุฎุฏู ุจุงุณุชุฎุฏุงู DeepSeek API
    
    Args:
        text (str): ูุต ุฑุณุงูุฉ ุงููุณุชุฎุฏู
        user_info (dict): ูุนูููุงุช ุงููุณุชุฎุฏู ูู ููุณุจูู
        
    Returns:
        str: ุงููุต ุงููุงุชุฌ ูู DeepSeek ููุฑุฏ ุนูู ุงููุณุชุฎุฏู
    """
    try:
        # ูุธุงู ุงูุจุฑููุจุช ุงูุฐู ููุฌู ุงูุฐูุงุก ุงูุงุตุทูุงุนู ููุฅุฌุงุจุฉ ุจุดูู ููุงุณุจ
        system_prompt = """
        ุฃูุช ูุณุงุนุฏ ุดุฑูุฉ NeoFikr Solutions ููุฐูุงุก ุงูุงุตุทูุงุนู ูุงูุชุญูู ุงูุฑููู. ูู ุจุงูุฑุฏ ุนูู ุงุณุชูุณุงุฑุงุช ุงูุนููุงุก ุจุฃุณููุจ ูุฏู ูุงุญุชุฑุงูู.
        
        ูุนูููุงุช ุงูุดุฑูุฉ:
        - ุงูุงุณู: NeoFikr Solutions
        - ุงููุฌุงู: ุงูุฐูุงุก ุงูุงุตุทูุงุนู ูุงูุชุญูู ุงูุฑููู
        - ุงูุฎุฏูุงุช: ุดุงุช ุจูุชุ ุฃูุธูุฉ CRMุ ุชุญููู ุจูุงูุงุชุ ุฃุชูุชุฉ ุนูููุงุชุ ุชุตููู ูุงุฌูุงุชุ ุชุฏุฑูุจ ูุงุณุชุดุงุฑุงุช
        - ุฑูู ุงูุชูุงุตู: 01121891913
        - ุงูุจุฑูุฏ: neofikrsolutions@gmail.com
        - ุงููููุน: https://neofikr.blogspot.com/
        
        ุจุงูุงุช ุฎุฏูุงุช ุงูุดุงุช ุจูุช:
        - ุจุงูุฉ Pro (Starter): 299 ุฌ.ู ุดูุฑููุง - ููุดุฑูุงุช ุงูุตุบูุฑุฉ (ุญุชู 1000 ูุชุงุจุน)
        - ุจุงูุฉ Business: 999 ุฌ.ู ุดูุฑููุง - ููุดุฑูุงุช ุงููุชูุณุทุฉ (ุญุชู 5000 ูุชุงุจุน)
        - ุจุงูุฉ Growth: 2,500 ุฌ.ู ุดูุฑููุง - ููุดุฑูุงุช ุงููุงููุฉ (ุญุชู 15000 ูุชุงุจุน)
        - ุจุงูุฉ Enterprise: ุจุฏุกูุง ูู 6,000 ุฌ.ู ุดูุฑููุง - ููุดุฑูุงุช ุงููุจูุฑุฉ (ุบูุฑ ูุญุฏูุฏ)
        
        ุจุงูุงุช ุฎุฏูุงุช CRM ูุชุญููู ุงูุจูุงูุงุช:
        - ุญุฒูุฉ Startup: 4,500 ุฌ.ู ุดูุฑููุง
        - ุญุฒูุฉ Growth: 9,800 ุฌ.ู ุดูุฑููุง
        - ุญุฒูุฉ Enterprise: 25,000 ุฌ.ู + ุดูุฑููุง
        
        ุฃุณุนุงุฑ ุงูุชุฏุฑูุจ ูุงูุงุณุชุดุงุฑุงุช:
        - ุฏูุฑุฉ ุชุฏุฑูุจูุฉ (8 ุณุงุนุงุช): 1,500 ุฌ.ู ูููุฑุฏ
        - ุฎุทุฉ ุฏุนู ูููุฒ (24/7): 1,200 ุฌ.ู / ุดูุฑ
        
        ุนูุฏ ุทูุจ ุงูุนููู ูุนูููุงุช ุนู ุงูุฃุณุนุงุฑุ ูุฏู ูู ุงูุชูุงุตูู ูุงุนุฑุถ ุนููู ุงูุชุญุฏุซ ูุน ูุฑูู ุงููุจูุนุงุช.
        ุฅุฐุง ุทูุจ ุงูุนููู ุฎุฏูุฉ ูุนููุฉุ ุงุทูุจ ููู ุชูุงุตูู ุฃูุซุฑ ููุฌูู ููุชูุงุตู ูุน ูุฑูู ุงููุจูุนุงุช.
        ุญุงูู ุฏุงุฆููุง ุงูุฅุฌุงุจุฉ ุจุฅูุฌุงุฒ ููุถูุญุ ูุงุญุฑุต ุนูู ุงูุชุฑุญูุจ ุจุงูุนููู ูุชูุฏูู ุงููุณุงุนุฏุฉ.
        
        ุฅุฐุง ูุชุจ ุงูุนููู ุฑูููุง ูู 1 ุฅูู 5ุ ููู ูุฎุชุงุฑ ูู ุงููุงุฆูุฉ ุงูุฑุฆูุณูุฉ:
        1 - ุฎุฏูุงุช ุงูุดุฑูุฉ
        2 - ุชุญููู ุฏููู ุฃุฏูุงุช ุงูุฐูุงุก ุงูุงุตุทูุงุนู
        3 - ูุดุงูุฏุฉ ุงูููุฑุณุงุช ูุงูุฏูุฑุงุช
        4 - ุทูุจ ุงุณุชุดุงุฑุฉ ุฃู ุนุฑุถ ุณุนุฑ
        5 - ุงูุชุญุฏุซ ูุน ุฃุญุฏ ุฃุนุถุงุก ุงููุฑูู
        
        ุฅุฐุง ูุชุจ ูููุฉ "ูุงุฆูุฉ" ุฃู "menu" - ุงุนุฑุถ ุงููุงุฆูุฉ ุงูุฑุฆูุณูุฉ
        """
        
        # ุฅุนุฏุงุฏ ุงูููุฏุฑุฒ ููุทูุจ
        headers = {
            "Authorization": f"Bearer {DEEPSEEK_API_KEY}",
            "Content-Type": "application/json"
        }
        
        # ุฅุนุฏุงุฏ ุจูุงูุงุช ุงูุทูุจ
        data = {
            "model": DEFAULT_MODEL,
            "messages": [
                {"role": "system", "content": system_prompt},
                {"role": "user", "content": text}
            ],
            "temperature": TEMPERATURE,
            "max_tokens": MAX_TOKENS
        }
        
        # ูู ุญุงูุฉ ุนุฏู ุชููุฑ ุฃู ุชูููู APIุ ูุณุชุฎุฏู ุงูุฑุฏูุฏ ุงูุซุงุจุชุฉ ููุงุฎุชุจุงุฑ
        if DEEPSEEK_API_KEY == 'your_deepseek_api_key':
            print("ุงุณุชุฎุฏุงู ูุถุน ุงูุงุฎุชุจุงุฑ (ูุญุงูุงุฉ API) ููุฑุฏูุฏ")
            return get_mock_response(text)
            
        # ุฅุฑุณุงู ุงูุทูุจ ุฅูู DeepSeek API
        print(f"ุฅุฑุณุงู ุทูุจ ุฅูู DeepSeek API: {DEEPSEEK_API_URL}")
        response = requests.post(DEEPSEEK_API_URL, headers=headers, json=data)
        
        if response.status_code == 200:
            # ุงุณุชุฎุฑุงุฌ ุงููุต ุงููููุฏ ูู ุงุณุชุฌุงุจุฉ API
            response_data = response.json()
            generated_text = response_data["choices"][0]["message"]["content"]
            print(f"ุชู ุงุณุชูุงู ุฑุฏ ูู DeepSeek API ุจูุฌุงุญ ({len(generated_text)} ุญุฑู)")
            return generated_text
        else:
            print(f"ุฎุทุฃ ูู DeepSeek API: ุงูุฑูุฒ {response.status_code}")
            try:
                print(f"ุฑุณุงูุฉ ุงูุฎุทุฃ: {response.json()}")
            except:
                print(f"ูุต ุงูุงุณุชุฌุงุจุฉ ุงูุฎุงู: {response.text}")
            return "ุนุฐุฑูุงุ ุญุฏุซ ุฎุทุฃ ูู ูุนุงูุฌุฉ ุทูุจู. ูุฑุฌู ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู ุฃู ุงูุชูุงุตู ูุนูุง ูุจุงุดุฑุฉ ุนูู 01121891913."
    
    except Exception as e:
        print(f"ุฎุทุฃ ูู ุทูุจ DeepSeek API: {e}")
        return get_mock_response(text)  # ุงุณุชุฎุฏุงู ุงูุฑุฏูุฏ ุงูุซุงุจุชุฉ ูู ุญุงูุฉ ุงูุฎุทุฃ

def get_mock_response(text):
    """
    ุงูุญุตูู ุนูู ุฑุฏูุฏ ุซุงุจุชุฉ ููุงุฎุชุจุงุฑ ูู ุญุงูุฉ ุนุฏู ุชููุฑ API
    
    Args:
        text (str): ูุต ุฑุณุงูุฉ ุงููุณุชุฎุฏู
        
    Returns:
        str: ุฑุฏ ุซุงุจุช ููุงุณุจ ููุฑุณุงูุฉ
    """
    text_lower = text.lower()
    
    if "1" == text or "ุฎุฏูุงุช" in text_lower:
        return "ุฎุฏูุงุช ุงูุดุฑูุฉ ูููุฑ ูุฌููุนุฉ ูู ุงูุฎุฏูุงุช ุงูุฐููุฉ:\n๐น ุชุตููู ุดุงุช ุจูุช ุงุญุชุฑุงูู\n๐น ุฅูุดุงุก CRM ูุฎุตุต ูุฅุฏุงุฑุฉ ุงูุนููุงุก\n๐น ุฃุฏูุงุช ุชุญููู ุจูุงูุงุช ููุฑุงูุจุฉ ุงูุฃุฏุงุก\n๐น ุฃุชูุชุฉ ุงูุนูููุงุช ุงูุฑูููุฉ\n๐น ุชุตููู ูุงุฌูุงุช ุฐููุฉ ููุชุทุจููุงุช\n๐น ุงุณุชุดุงุฑุงุช ูุชุฏุฑูุจ ูู ุงูุฐูุงุก ุงูุงุตุทูุงุนู\n\nุงูุชุจ ุฑูู ุงูุฎุฏูุฉ ููุฒูุฏ ูู ุงูุชูุงุตูู."
    
    elif "2" == text or "ุฏููู" in text_lower:
        return "ุชุญููู ุงูุฏููู ุงููุฌุงูู ๐ ุฅููู ุฏููููุง ุงูุนููู:\n\"ุฃููู 10 ุฃุฏูุงุช ุฐูุงุก ุงุตุทูุงุนู ุชุณุงุนุฏู ูู ุฅุฏุงุฑุฉ ูุดุฑูุนู\"\n๐ฅ ุฑุงุจุท ุงูุชุญููู: https://neofikr.blogspot.com/ai-tools-guide"
    
    elif "3" == text or "ููุฑุณ" in text_lower or "ุฏูุฑุฉ" in text_lower:
        return "ูุดุงูุฏุฉ ุงูููุฑุณุงุช ๐ ุงูุฏูุฑุงุช ุงููุชุงุญุฉ ุญุงูููุง:\n\nโช๏ธ ุฏูุฑุฉ: ููู ุชุจุฏุฃ ูุดุฑูุนู ุจุงุณุชุฎุฏุงู ุฃุฏูุงุช AI\nโช๏ธ ูุฑุดุฉ: ุฅูุดุงุก ุดุงุช ุจูุช ูุนููู ุฎูุงู 60 ุฏูููุฉ\nโช๏ธ ุชุฏุฑูุจ ุนููู ุนูู ุฃุฏูุงุช Canva AI ูChatGPT\n\n๐ข ููุชุณุฌูู ุฃู ูุดุงูุฏุฉ ุงูุชูุงุตููุ ุงุถุบุท ููุง: https://neofikr.blogspot.com/courses"
    
    elif "4" == text or "ุงุณุชุดุงุฑุฉ" in text_lower:
        return "ุทูุจ ุงุณุชุดุงุฑุฉ ูู ูุถูู ุฃุฑุณู ููุง:\n\nโช๏ธ ุงุณูู ุงููุงูู\nโช๏ธ ุทุจูุนุฉ ูุดุฑูุนู\nโช๏ธ ูุง ุงูุฐู ุชุญุชุงุฌ ุฅููู (ุดุงุช ุจูุชุ CRMุ ุชุฏุฑูุจุ)\n\nูุณูุชู ุงูุฑุฏ ุนููู ุฎูุงู 24 ุณุงุนุฉ ูู ูุฑูููุง ุงููุชุฎุตุต."
    
    elif "5" == text or "ุชูุงุตู" in text_lower:
        return "ุณูุชู ุชุญูููู ุงูุขู ุฅูู ุฃุญุฏ ุฃุนุถุงุก ุงููุฑูู ุนุจุฑ ุงููุงุชุณุงุจ.\n๐ 01121891913"
    
    elif "ุณุนุฑ" in text_lower or "ุชูููุฉ" in text_lower or "ุฃุณุนุงุฑ" in text_lower:
        return "ุจุงูุงุช ุงูุฎุฏูุงุช ูุฏููุง:\n\n" + \
               "โช๏ธ ุจุงูุฉ Pro (Starter): 299 ุฌ.ู ุดูุฑููุง - ููุดุฑูุงุช ุงูุตุบูุฑุฉ\n" + \
               "โช๏ธ ุจุงูุฉ Business: 999 ุฌ.ู ุดูุฑููุง - ููุดุฑูุงุช ุงููุชูุณุทุฉ\n" + \
               "โช๏ธ ุจุงูุฉ Growth: 2,500 ุฌ.ู ุดูุฑููุง - ููุดุฑูุงุช ุงููุงููุฉ\n" + \
               "โช๏ธ ุจุงูุฉ Enterprise: ุจุฏุกูุง ูู 6,000 ุฌ.ู ุดูุฑููุง - ููุดุฑูุงุช ุงููุจูุฑุฉ\n\n" + \
               "ูู ุชุฑุบุจ ูู ุงูุชุญุฏุซ ูุน ุฃุญุฏ ุฃุนุถุงุก ูุฑูู ุงููุจูุนุงุช ููุญุตูู ุนูู ุนุฑุถ ูุฎุตุตุ"
    
    elif "ุทูุจ" in text_lower or "ุฎุฏูุฉ" in text_lower or "ุงุทูุจ" in text_lower:
        return "ุดูุฑูุง ูุงูุชูุงูู ุจุฎุฏูุงุชูุง! ูููุฏู ูู ุฃูุถู ุญูุ ูุญุชุงุฌ ุฅูู ุจุนุถ ุงููุนูููุงุช:\n\n" + \
               "โช๏ธ ูุง ูู ูุฌุงู ุนูููุ\n" + \
               "โช๏ธ ูุง ูู ุงูุฎุฏูุฉ ุงูุชู ุชูุชู ุจูุง ุชุญุฏูุฏูุงุ\n" + \
               "โช๏ธ ูู ูุฏูู ููุนุฏ ูุญุฏุฏ ุชุญุชุงุฌ ููู ุฅุทูุงู ุงููุดุฑูุนุ\n\n" + \
               "ุณูููู ูุฑูููุง ุจุงูุชูุงุตู ูุนู ูุฑูุจูุง ุนูู ุงูุฑูู ุงููุณุฌู ูุฏูู."
    
    elif "ุดุงุช ุจูุช" in text_lower or "chatbot" in text_lower:
        return "ุฎุฏูุฉ ุงูุดุงุช ุจูุช ๐ค ูู NeoFikr ุชููุญู:\n\n" + \
               "โ ุจูุช ุฐูู ูุฑุฏ ุนูู ูู ุงุณุชูุณุงุฑุงุช ุนููุงุฆู\n" + \
               "โ ุฌูุน ุจูุงูุงุช ุงูุนููุงุก ูุชุญููููู ููุจูุนุงุช\n" + \
               "โ ุฑุจุท ูุน ููุณุจูู ุฃู ูุงุชุณุงุจ ุฃู ูููุนู\n" + \
               "โ ูุนูู 24/7 ุจุฏูู ุชููู\n\n" + \
               "ุฃุณุนุงุฑูุง ุชุจุฏุฃ ูู 299 ุฌ.ู ุดูุฑููุง. ูู ุชุฑุบุจ ูู ูุนุฑูุฉ ุงููุฒูุฏุ"
    
    elif "ูุงุฆูุฉ" in text_lower or "menu" in text_lower:
        return "ุงููุงุฆูุฉ ุงูุฑุฆูุณูุฉ ๐\n\n" + \
               "1๏ธโฃ ุฎุฏูุงุช ุงูุดุฑูุฉ\n" + \
               "2๏ธโฃ ุชุญููู ุฏููู ุฃุฏูุงุช ุงูุฐูุงุก ุงูุงุตุทูุงุนู\n" + \
               "3๏ธโฃ ูุดุงูุฏุฉ ุงูููุฑุณุงุช ูุงูุฏูุฑุงุช\n" + \
               "4๏ธโฃ ุทูุจ ุงุณุชุดุงุฑุฉ ุฃู ุนุฑุถ ุณุนุฑ\n" + \
               "5๏ธโฃ ุงูุชุญุฏุซ ูุน ุฃุญุฏ ุฃุนุถุงุก ุงููุฑูู\n\n" + \
               "ุงุฎุชุฑ ุฑูู ุงูุฎุฏูุฉ ุฃู ุงูุชุจ ุงุณุชูุณุงุฑู ูุณุฃุณุงุนุฏู."
    
    else:
        return "ุดูุฑูุง ูุชูุงุตูู ูุน NeoFikr Solutions! ููููู ุงุฎุชูุงุฑ ูู ุงููุงุฆูุฉ ุงูุชุงููุฉ:\n\n" + \
               "1๏ธโฃ ุฎุฏูุงุช ุงูุดุฑูุฉ\n" + \
               "2๏ธโฃ ุชุญููู ุฏููู ุฃุฏูุงุช ุงูุฐูุงุก ุงูุงุตุทูุงุนู\n" + \
               "3๏ธโฃ ูุดุงูุฏุฉ ุงูููุฑุณุงุช ูุงูุฏูุฑุงุช\n" + \
               "4๏ธโฃ ุทูุจ ุงุณุชุดุงุฑุฉ ุฃู ุนุฑุถ ุณุนุฑ\n" + \
               "5๏ธโฃ ุงูุชุญุฏุซ ูุน ุฃุญุฏ ุฃุนุถุงุก ุงููุฑูู\n\n" + \
               "ุฃู ููููู ูุชุงุจุฉ ุงุณุชูุณุงุฑู ูุณุฃุญุงูู ูุณุงุนุฏุชู."
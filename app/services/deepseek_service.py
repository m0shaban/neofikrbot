import os
import requests
import json

# الحصول على إعدادات DeepSeek API من ملف .env
DEEPSEEK_API_KEY = os.environ.get('DEEPSEEK_API_KEY', 'your_deepseek_api_key')
DEEPSEEK_API_URL = os.environ.get('DEEPSEEK_API_URL', 'https://api.deepseek.com/v1/chat/completions')
DEFAULT_MODEL = os.environ.get('DEFAULT_MODEL', 'deepseek-chat')
MAX_TOKENS = int(os.environ.get('MAX_TOKENS', 800))
TEMPERATURE = float(os.environ.get('TEMPERATURE', 0.7))

def get_deepseek_response(text):
    """
    معالجة رسائل المستخدم باستخدام DeepSeek API - واجهة مبسطة
    
    Args:
        text (str): نص رسالة المستخدم
        
    Returns:
        str: النص الناتج من DeepSeek للرد على المستخدم
    """
    # استدعاء الدالة الأساسية مع توفير user_info كقاموس فارغ
    return process_with_deepseek(text, {})

def process_with_deepseek(text, user_info):
    """
    معالجة رسائل المستخدم باستخدام DeepSeek API
    
    Args:
        text (str): نص رسالة المستخدم
        user_info (dict): معلومات المستخدم من فيسبوك
        
    Returns:
        str: النص الناتج من DeepSeek للرد على المستخدم
    """
    try:
        # نظام البرومبت الذي يوجه الذكاء الاصطناعي للإجابة بشكل مناسب
        system_prompt = """
        أنت مساعد شات بوت متخصص لشركة NeoFikr Solutions للذكاء الاصطناعي والتحول الرقمي. دورك هو التواصل مع العملاء بلهجة مصرية طبيعية جداً ودودة واحترافية في نفس الوقت.
        
        اسلوبك:
        - استخدم اللهجة المصرية العامية السلسة (مش الفصحى)
        - كن ودود وقريب من العميل كأنك صديق محترف
        - استخدم الإيموجيز بشكل مناسب ومتكرر 🔥✨🚀💯
        - ابدأ دائماً بتحية مصرية مثل "أهلاً بيك" أو "منور يا فندم"
        - رد بشكل طبيعي وممتع وحيوي كأنك شخص حقيقي
        - تجنب الإجابات الطويلة والمملة، اجعلها موجزة ومفيدة
        - اجعل الإجابات متماسكة ومتكاملة ومتناسقة المقاطع
        - لا تكرر نفس العبارات مثل "كيف يمكنني مساعدتك"
        
        معلومات الشركة:
        - الاسم: NeoFikr Solutions
        - المجال: الذكاء الاصطناعي والتحول الرقمي
        - الخدمات: شات بوت، أنظمة CRM، تحليل بيانات، أتمتة عمليات، تصميم واجهات، تدريب واستشارات
        - رقم التواصل: 01121891913 (واتساب)
        - البريد: neofikrsolutions@gmail.com
        - الموقع: https://neofikr.blogspot.com/
        
        باقات خدمات الشات بوت:
        - باقة Pro (Starter): 299 ج.م شهريًا - للشركات الصغيرة (حتى 1000 متابع)
          تشمل: شات بوت أساسي، إعداد أولي، تحديثات شهرية، دعم فني بالإيميل، تقارير أساسية
        - باقة Business: 999 ج.م شهريًا - للشركات المتوسطة (حتى 5000 متابع)
          تشمل: جميع مميزات Pro + تكامل مع CRM، دعم فني بالواتساب، تقارير أسبوعية، تخصيص متقدم
        - باقة Growth: 2,500 ج.م شهريًا - للشركات النامية (حتى 15000 متابع)
          تشمل: جميع مميزات Business + تدريب الفريق، تحديثات أسبوعية، دعم فني مخصص، تكامل مع أنظمة متعددة
        - باقة Enterprise: بدءًا من 6,000 ج.م شهريًا - للشركات الكبيرة (غير محدود)
          تشمل: حل شامل مخصص بالكامل، خدمة VIP، مدير حساب خاص، تطويرات مستمرة
        
        كيف تتعامل مع طلبات العملاء:
        - عندما يطلب العميل معلومات عن خدمة معينة: قدم شرح موجز عنها مع مميزاتها وسعرها
        - عندما يطلب العميل استشارة أو خدمة: اطلب منه بياناته (الاسم، الشركة، نوع الخدمة، رقم الهاتف، البريد الإلكتروني) واشرح أنك سجلت طلبه وسيتم التواصل معه
        - إذا قدم العميل بالفعل معلومات التواصل: أكد استلام الطلب وأخبره أن فريق المبيعات سيتواصل معه خلال 24 ساعة
        - إذا كان العميل يريد اختيار باقة معينة: اشرح تفاصيلها وأكد الطلب واشكره واطلب تفاصيل التواصل إذا لم تكن متوفرة
        
        تذكر دائماً أنك تمثل الشركة وهدفك هو تحويل المحادثات إلى عملاء حقيقيين وتقديم أفضل خدمة ممكنة.
        """
        
        # إعداد الهيدرز للطلب
        headers = {
            "Authorization": f"Bearer {DEEPSEEK_API_KEY}",
            "Content-Type": "application/json"
        }
        
        # إعداد بيانات الطلب
        data = {
            "model": DEFAULT_MODEL,
            "messages": [
                {"role": "system", "content": system_prompt},
                {"role": "user", "content": text}
            ],
            "temperature": TEMPERATURE,
            "max_tokens": MAX_TOKENS
        }
        
        # في حالة عدم توفر أو تكوين API، نستخدم الردود الثابتة للاختبار
        if DEEPSEEK_API_KEY == 'your_deepseek_api_key':
            print("استخدام وضع الاختبار (محاكاة API) للردود")
            return get_mock_response(text)
            
        # إرسال الطلب إلى DeepSeek API
        print(f"إرسال طلب إلى DeepSeek API: {DEEPSEEK_API_URL}")
        response = requests.post(DEEPSEEK_API_URL, headers=headers, json=data)
        
        if response.status_code == 200:
            # استخراج النص المولد من استجابة API
            response_data = response.json()
            generated_text = response_data["choices"][0]["message"]["content"]
            print(f"تم استلام رد من DeepSeek API بنجاح ({len(generated_text)} حرف)")
            return generated_text
        else:
            print(f"خطأ في DeepSeek API: الرمز {response.status_code}")
            try:
                print(f"رسالة الخطأ: {response.json()}")
            except:
                print(f"نص الاستجابة الخام: {response.text}")
            return "عذرًا، حدث خطأ في معالجة طلبك. يمكنك التواصل معنا مباشرة على 01121891913. 🙏"
    
    except Exception as e:
        print(f"خطأ في طلب DeepSeek API: {e}")
        return get_mock_response(text)  # استخدام الردود الثابتة في حالة الخطأ

def get_mock_response(text):
    """
    الحصول على ردود ثابتة للاختبار في حالة عدم توفر API
    
    Args:
        text (str): نص رسالة المستخدم
        
    Returns:
        str: رد ثابت مناسب للرسالة
    """
    text_lower = text.lower()
    
    if "1" == text or "خدمات" in text_lower:
        return "أهلا بيك يا باشا! 😍 إحنا في نيوفكر بنقدم خدمات متنوعة:\n\n🚀 شات بوت ذكي لخدمة عملائك 24/7\n💼 نظام CRM مخصص لإدارة العملاء\n📊 أدوات تحليل بيانات ومراقبة أداء\n⚡ أتمتة العمليات الرقمية بالذكاء الاصطناعي\n🎨 تصميم واجهات ويب وموبايل\n🧠 استشارات وتدريب في الذكاء الاصطناعي\n\nعايز تعرف تفاصيل أكتر عن أي خدمة؟ قولي وأنا موجود! 💪"
    
    elif "2" == text or "دليل" in text_lower:
        return "أحلى هدية مجانية وصلتك! 🎁 دليل \"أقوى 10 أدوات ذكاء اصطناعي تساعدك تكبر مشروعك\" جاهز للتحميل.\n\n📥 ادخل على الرابط ده واحصل على نسختك: https://neofikr.blogspot.com/ai-tools-guide\n\nالدليل هيساعدك تفهم أحدث تقنيات الذكاء الاصطناعي وإزاي تستخدمها عشان تطور شغلك! 🚀"
    
    elif "3" == text or "كورس" in text_lower or "دورة" in text_lower:
        return "كورسات نيوفكر هتخليك محترف! 🤓✌️\n\n🔥 كورس \"كيف تبدأ مشروعك باستخدام أدوات الذكاء الاصطناعي\" - عملي 100%\n🔥 ورشة \"إنشاء شات بوت لمشروعك خلال 60 دقيقة\" - نتائج سريعة!\n🔥 دورة \"استخدام Canva AI وChatGPT في التسويق\" - تعلم وطبق على طول!\n\nعايز تحجز أي دورة أو تعرف مواعيدها؟ زور موقعنا: https://neofikr.blogspot.com/courses 📚"
    
    elif "4" == text or "استشارة" in text_lower:
        return "نفسي أساعدك بخبرتنا! 🤩 عشان نقدر نقدملك استشارة مظبوطة، محتاجين منك الداتا دي:\n\n👤 اسمك الكامل\n🏢 طبيعة مشروعك\n📋 الخدمة اللي محتاجها\n📧 إيميلك\n📱 رقم الواتساب\n\nبعد ما تبعتلنا المعلومات دي، هنتواصل معاك خلال 24 ساعة وهنساعدك تطور مشروعك بأحدث تقنيات الذكاء الاصطناعي! 🚀💯"
    
    elif "5" == text or "تواصل" in text_lower:
        return "تمام يا باشا! 👍 هنحولك دلوقتي لحد من فريق المبيعات عشان يساعدك أكتر.\n\nممكن تتواصل معانا عالواتساب: 📲 01121891913\n\nأو تبعتلنا عالإيميل: 📧 neofikrsolutions@gmail.com\n\nمستنيين رسالتك وهنرد عليك في أسرع وقت! ⚡"
    
    elif "سعر" in text_lower or "تكلفة" in text_lower or "أسعار" in text_lower:
        return "أسعارنا مناسبة لكل المشاريع يا كبير! 💰💯\n\n🔹 باقة Pro (299ج.م شهريًا): للشركات الصغيرة (لحد 1000 متابع)\n🔹 باقة Business (999ج.م شهريًا): للشركات المتوسطة (لحد 5000 متابع)\n🔹 باقة Growth (2,500ج.م شهريًا): للشركات النامية (لحد 15000 متابع)\n🔹 باقة Enterprise (بدءًا من 6,000ج.م شهريًا): للشركات الكبيرة\n\nعايز أسعار مخصصة لمشروعك؟ كلمنا على 01121891913 وهنعملك عرض خاص يناسب احتياجاتك! 🤝✨"
    
    elif "طلب" in text_lower or "خدمة" in text_lower or "اطلب" in text_lower:
        return "شكراً لاهتمامك بخدماتنا يا كينج! 🙏✨\n\nعشان نقدر نساعدك بشكل احترافي، ياريت تبعتلنا:\n\n👤 اسمك الكامل\n🏢 نشاط شركتك أو مشروعك\n📋 الخدمة اللي محتاجها بالظبط\n📧 الإيميل بتاعك\n📱 رقم الواتساب للتواصل\n\nأول ما تبعت البيانات دي هنسجل طلبك على طول، وفريقنا هيتواصل معاك خلال 24 ساعة بالكتير! 🚀💯"
    
    elif "شات بوت" in text_lower or "chatbot" in text_lower:
        return "شات بوت نيوفكر هيغير طريقة شغلك بالكامل! 🤖🔥\n\n✅ هيرد على عملائك 24/7 بدون راحة\n✅ هيجمعلك ليدز وبيانات عملاء جديدة\n✅ هيشتغل على فيسبوك أو واتساب أو حتى موقعك\n✅ هيوفرلك وقت وفلوس ويزود مبيعاتك\n\nأسعارنا تبدأ من 299ج.م بس في الشهر! 💰\n\nعايز تعرف تفاصيل أكتر؟ ابعتلنا بياناتك (اسمك، إيميلك، رقمك) وهنشرحلك كل حاجة وكمان ممكن نعملك ديمو مجاني! 🎁"
    
    elif "قائمة" in text_lower or "menu" in text_lower:
        return "القائمة الرئيسية اتفضل يا باشا! 📋✨\n\n1️⃣ خدمات شركة نيوفكر\n2️⃣ دليل أدوات الذكاء الاصطناعي (مجاني)\n3️⃣ الكورسات والدورات\n4️⃣ طلب استشارة أو عرض سعر\n5️⃣ التحدث مع فريق المبيعات\n\nاختار الخدمة اللي تناسبك أو اكتبلي على طول اللي في دماغك وأنا هساعدك! 😎🚀"
    
    else:
        return "أهلاً بيك في نيوفكر سوليوشنز! 😍👋\n\nإحنا هنا عشان نساعدك تطور شغلك باستخدام الذكاء الاصطناعي. شوف الخدمات دي:\n\n1️⃣ خدمات الشركة (شات بوت، CRM، تحليل بيانات، وغيرها)\n2️⃣ دليل أدوات الذكاء الاصطناعي (مجاني للتحميل)\n3️⃣ كورسات وتدريبات عملية\n4️⃣ استشارة مجانية لمشروعك\n5️⃣ التحدث مع حد من فريقنا\n\nممكن تختار رقم أو تقولي على طول أنت محتاج إيه وأنا هساعدك! 🚀💪"